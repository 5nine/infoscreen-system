<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sj√§levads Bygg - Info Sk√§rm</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f0f0;
            color: #333;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 400px;
            grid-template-rows: 100px 1fr 100px;
            width: 100%;
            height: 100%;
            background: white;
            max-width: 1920px;
            max-height: 1080px;
            margin: 0 auto;
        }
        .header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 40px;
        }
        .logo-section { display: flex; align-items: center; gap: 20px; }
        .logo { height: 70px; filter: brightness(0) invert(1); }
        .company-info h1 { font-size: 28px; margin-bottom: 5px; }
        .company-info p { font-size: 16px; opacity: 0.9; }
        .datetime-section { text-align: right; }
        #current-date { font-size: 24px; margin-bottom: 5px; }
        #current-time { font-size: 32px; font-weight: 700; }
        .main-content {
            grid-column: 1;
            grid-row: 2;
            position: relative;
            background: #000;
        }
        .slideshow-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        .slide {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        .slide.active { opacity: 1; }
        .slide-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }
        .slide-info {
            position: absolute;
            bottom: 80px;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px 40px;
            text-align: center;
        }
        .slide-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .slide-description {
            font-size: 18px;
            opacity: 0.9;
        }
        .slide-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            align-items: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 50px;
        }
        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        #slideCounter {
            color: white;
            margin: 0 15px;
            display: flex;
            align-items: center;
            font-size: 20px;
            min-width: 80px;
            justify-content: center;
        }
        .sidebar {
            grid-column: 2;
            grid-row: 2;
            background: #f8f9fa;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 30px;
            overflow-y: auto;
        }
        .weather-section, .calendar-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .weather-section h2, .calendar-section h2 {
            margin-bottom: 20px;
            color: #1e3c72;
            font-size: 22px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }
        .footer {
            grid-column: 1 / -1;
            background: #2c3e50;
            color: white;
            padding: 0 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 16px;
        }
        .loading-overlay {
            position: fixed;
            top: 0; 
            left: 0;
            width: 100%; 
            height: 100%;
            background: #1e3c72;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-in-out;
        }
        .loading-overlay.hidden { 
            opacity: 0; 
            pointer-events: none; 
        }
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .error-message {
            background: #ff6b6b;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        .error-message.show {
            display: block;
        }
        .no-images {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #1e3c72;
            color: white;
            text-align: center;
            padding: 40px;
        }
        .no-images h2 {
            font-size: 36px;
            margin-bottom: 20px;
        }
        .no-images p {
            font-size: 20px;
            opacity: 0.9;
        }
        .image-fallback {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            padding: 40px;
        }
        .image-fallback i {
            font-size: 72px;
            margin-bottom: 20px;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div style="color: white; font-size: 24px; margin-top: 20px;">Startar system...</div>
    </div>

    <div class="container">
        <header class="header">
            <div class="logo-section">
                <img src="logo.png" alt="Sj√§levads Bygg Logo" class="logo" onerror="this.style.display='none'">
                <div class="company-info">
                    <h1>SJ√ÑLEVADS BYGG AB</h1>
                    <p>Kvalitet & H√•llbarhet sedan 1995</p>
                </div>
            </div>
            <div class="datetime-section">
                <div id="current-date">l√∂rdag 16 december 2023</div>
                <div id="current-time">14:30:45</div>
            </div>
        </header>

        <main class="main-content">
            <div class="slideshow-container" id="slideshowContainer">
                <!-- Slides kommer att genereras h√§r av JavaScript -->
            </div>
            <div class="slide-controls">
                <button class="control-btn" id="prevBtn" aria-label="F√∂reg√•ende bild">
                    <i class="fas fa-chevron-left"></i>
                </button>
                
                <div id="slideCounter">
                    <span id="currentSlide">1</span> / <span id="totalSlides">0</span>
                </div>
                
                <button class="control-btn" id="playPauseBtn" aria-label="Pausa/starta bildspel">
                    <i class="fas fa-pause"></i>
                </button>
                
                <button class="control-btn" id="nextBtn" aria-label="N√§sta bild">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </main>

        <aside class="sidebar">
            <section class="weather-section">
                <h2>V√§der - √ñrnsk√∂ldsvik</h2>
                <div id="weatherInfo">Laddar v√§derinformation...</div>
            </section>
            <section class="calendar-section">
                <h2>Kalender</h2>
                <div id="calendarInfo">Laddar kalenderh√§ndelser...</div>
            </section>
        </aside>

        <footer class="footer">
            <div>Uppdaterad: <span id="lastUpdate">Just nu</span></div>
            <div>Systemstatus: <span id="systemStatus" style="color: #4CAF50;">‚óè Online</span></div>
        </footer>
    </div>

    <script>
        // Globala variabler
        let currentSlide = 0;
        let slides = [];
        let slideInterval;
        let isPlaying = true;
        let isLoading = false;

        // V√§nta p√• att DOM ska laddas
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Starting Sj√§levads Bygg Info Screen...');
            
            // Initiera alla komponenter
            initDateTime();
            await loadSlides();
            initSlideshow();
            loadWeather();
            loadCalendar();
            
            // D√∂lj laddningssk√§rmen efter 1 sekund
            setTimeout(() => {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }, 1000);
            
            // Uppdatera sist uppdaterad-tid varje minut
            setInterval(updateLastUpdateTime, 60000);
            
            // Auto-refresh om inga bilder visas
            setTimeout(() => {
                if (slides.length === 0 && !isLoading) {
                    console.log('üîÑ No images found, attempting refresh...');
                    loadSlides();
                }
            }, 10000);
        });

        // Funktion f√∂r att initiera datum och tid
        function initDateTime() {
            function updateDateTime() {
                const now = new Date();
                const dateOptions = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                };
                
                // Uppdatera datum
                document.getElementById('current-date').textContent = 
                    now.toLocaleDateString('sv-SE', dateOptions);
                
                // Uppdatera tid
                document.getElementById('current-time').textContent = 
                    now.toLocaleTimeString('sv-SE', { 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        second: '2-digit' 
                    });
            }
            
            // Uppdatera direkt och sedan varje sekund
            updateDateTime();
            setInterval(updateDateTime, 1000);
        }

        // Ladda bilder fr√•n API
        async function loadSlides() {
            if (isLoading) return;
            
            isLoading = true;
            try {
                console.log('üì∏ Loading images from API...');
                
                // F√∂rs√∂k h√§mta bilder fr√•n API:et
                const response = await fetch('/api/images');
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }
                
                slides = await response.json();
                console.log(`‚úÖ Loaded ${slides.length} image(s) from API`);
                
                // DEBUG: Visa vad vi fick fr√•n API:et
                console.log('üìã First slide data:', slides[0]);
                
                // Om inga bilder i databasen, kolla i mappen
                if (slides.length === 0) {
                    console.warn('‚ö†Ô∏è No images in database, checking images folder...');
                    await loadImagesFromFolder();
                }
                
                // Rendera bilderna
                renderSlides();
                
                // Uppdatera slide counter
                updateSlideCounter();
                
                // F√∂rhandsload n√§sta bild f√∂r b√§ttre prestanda
                preloadNextImage();
                
            } catch (error) {
                console.error('‚ùå Failed to load slides:', error);
                showErrorFallback();
            } finally {
                isLoading = false;
            }
        }

        // Ladda bilder fr√•n mappen som fallback
        async function loadImagesFromFolder() {
            try {
                const response = await fetch('/api/images-direct');
                if (!response.ok) throw new Error('Folder API failed');
                
                const images = await response.json();
                
                // Skapa slide-objekt fr√•n filnamnen
                slides = images
                    .filter(filename => /\.(jpg|jpeg|png|gif|webp)$/i.test(filename))
                    .map((filename, index) => ({
                        id: index + 1,
                        filename: filename,
                        title: filename.replace(/\.[^/.]+$/, "").replace(/[-_]/g, " "),
                        description: '',
                        order: index + 1,
                        active: true,
                        uploaded: new Date().toISOString()
                    }));
                
                console.log(`üìÅ Found ${slides.length} image(s) in folder`);
                
            } catch (folderError) {
                console.warn('üìÇ Using hardcoded fallback images');
                slides = [
                    { 
                        id: 1, 
                        filename: 'fallback.jpg', 
                        title: 'V√§lkommen till Sj√§levads Bygg', 
                        description: 'Info-sk√§rm systemet √§r klart f√∂r anv√§ndning' 
                    },
                    { 
                        id: 2, 
                        filename: 'construction.jpg', 
                        title: 'Byggarbeten p√•g√•r', 
                        description: 'Vi bygger f√∂r framtiden' 
                    }
                ];
            }
        }

        // Rendera alla slides i DOM
        function renderSlides() {
            const container = document.getElementById('slideshowContainer');
            
            // T√∂m containern f√∂rst
            container.innerHTML = '';
            
            // Om inga bilder, visa meddelande
            if (slides.length === 0) {
                container.innerHTML = `
                    <div class="no-images">
                        <h2>Inga bilder tillg√§ngliga</h2>
                        <p>Ladda upp bilder via admin-panelen f√∂r att b√∂rja anv√§nda info-sk√§rmen</p>
                        <p style="margin-top: 20px; font-size: 16px;">
                            <i class="fas fa-info-circle"></i> 
                            Kontrollera att servern √§r ig√•ng och att bilder finns i /images-mappen
                        </p>
                    </div>
                `;
                return;
            }
            
            // Skapa slide-element f√∂r varje bild
            slides.forEach((slide, index) => {
                const slideElement = document.createElement('div');
                slideElement.className = `slide ${index === 0 ? 'active' : ''}`;
                slideElement.dataset.index = index;
                slideElement.setAttribute('aria-hidden', index !== 0);
                slideElement.setAttribute('aria-label', `Bild ${index + 1}: ${slide.title || ''}`);
                
                // FIX: Anv√§nd r√§tt filnamn - testa olika f√§lt
                let imageFilename = slide.filename || slide.originalname || `image_${slide.id}.jpg`;
                
                // DEBUG: Logga vilket filnamn vi anv√§nder
                console.log(`Slide ${index + 1}:`, {
                    id: slide.id,
                    filename: slide.filename,
                    originalname: slide.originalname,
                    usingFilename: imageFilename
                });
                
                // Bygg bild-URL - ESCAPE specialtecken
                const imageUrl = `/images/${encodeURIComponent(imageFilename)}`;
                
                // Testa om bilden finns innan vi skapar HTML
                checkImageExists(imageUrl).then(exists => {
                    if (!exists) {
                        console.warn(`‚ö†Ô∏è Image not found: ${imageUrl}`);
                        console.log('Trying alternative filenames...');
                        
                        // Testa olika filnamn-variationer
                        const alternativeFilenames = [
                            slide.originalname,
                            slide.filename?.replace(/_/g, '-'),
                            `image_${slide.id}.jpg`,
                            'fallback.jpg'
                        ];
                        
                        // Testa varje alternativ
                        testAlternativeFilenames(alternativeFilenames, slideElement, slide);
                    }
                });
                
                // Skapa slide-inneh√•ll
                slideElement.innerHTML = `
                    <img src="${imageUrl}" 
                         alt="${slide.title || 'Bild ' + (index + 1)}" 
                         class="slide-image"
                         loading="${index === 0 ? 'eager' : 'lazy'}"
                         onerror="handleImageError(this, '${imageFilename.replace(/'/g, "\\'")}', ${slide.id})">
                    
                    ${slide.title || slide.description ? `
                    <div class="slide-info" aria-live="polite" aria-atomic="true">
                        ${slide.title ? `<div class="slide-title">${slide.title}</div>` : ''}
                        ${slide.description ? `<div class="slide-description">${slide.description}</div>` : ''}
                    </div>
                    ` : ''}
                `;
                
                container.appendChild(slideElement);
            });
        }

        // Testa alternativa filnamn
        async function testAlternativeFilenames(filenames, slideElement, slide) {
            for (const altFilename of filenames) {
                if (!altFilename) continue;
                
                const altUrl = `/images/${encodeURIComponent(altFilename)}`;
                const exists = await checkImageExists(altUrl);
                
                if (exists) {
                    console.log(`‚úÖ Found alternative: ${altFilename}`);
                    // Uppdatera bildens src
                    const img = slideElement.querySelector('img');
                    if (img) {
                        img.src = altUrl;
                        img.onerror = null; // Ta bort error handler
                    }
                    break;
                }
            }
        }

        // Kontrollera om en bild finns
        async function checkImageExists(url) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        // Global felhanterare f√∂r bilder - UPPDATERAD VERSION
        window.handleImageError = function(imgElement, filename, slideId) {
            console.warn(`‚ö†Ô∏è Failed to load image: ${filename} (Slide ID: ${slideId})`);
            
            // F√∂rs√∂k hitta slide-objektet
            const slide = slides.find(s => s.id == slideId);
            if (slide) {
                console.log('Slide object:', slide);
                
                // Testa alternativa filnamn
                const alternatives = [
                    slide.originalname,
                    slide.filename?.replace(/_\d+\./, '.'), // Ta bort timestamp
                    `image_${slideId}.jpg`,
                    'fallback.jpg'
                ];
                
                // Testa varje alternativ
                testImageAlternatives(imgElement, alternatives);
            } else {
                // Anv√§nd fallback
                useFallbackImage(imgElement);
            }
        };

        // Testa alternativa bilder
        function testImageAlternatives(imgElement, alternatives) {
            let currentIndex = 0;
            
            function tryNextAlternative() {
                if (currentIndex >= alternatives.length) {
                    useFallbackImage(imgElement);
                    return;
                }
                
                const altFilename = alternatives[currentIndex];
                if (!altFilename) {
                    currentIndex++;
                    tryNextAlternative();
                    return;
                }
                
                const altUrl = `/images/${encodeURIComponent(altFilename)}`;
                console.log(`Trying alternative ${currentIndex + 1}: ${altUrl}`);
                
                const testImg = new Image();
                testImg.onload = function() {
                    console.log(`‚úÖ Alternative works: ${altFilename}`);
                    imgElement.src = altUrl;
                    imgElement.onerror = null; // Ta bort error handler
                };
                
                testImg.onerror = function() {
                    console.log(`‚ùå Alternative failed: ${altFilename}`);
                    currentIndex++;
                    tryNextAlternative();
                };
                
                testImg.src = altUrl;
            }
            
            tryNextAlternative();
        }

        // Anv√§nd fallback-bild
        function useFallbackImage(imgElement) {
            console.log('Using fallback image');
            imgElement.src = 'https://images.unsplash.com/photo-1504307651254-35680f356dfd?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&h=1080&q=80';
            imgElement.alt = 'Fallback bild - Sj√§levads Bygg';
            imgElement.style.objectFit = 'cover';
            
            // Eller visa en enkel fallback med CSS
            imgElement.onerror = null;
            imgElement.outerHTML = `
                <div class="image-fallback">
                    <i class="fas fa-image"></i>
                    <h3>Sj√§levads Bygg</h3>
                    <p>Bilden "${imgElement.alt}" kunde inte laddas</p>
                </div>
            `;
        }

        // Visa fallback vid allvarliga fel
        function showErrorFallback() {
            const container = document.getElementById('slideshowContainer');
            container.innerHTML = `
                <div class="slide active">
                    <div class="no-images">
                        <h1>Sj√§levads Bygg Info-Sk√§rm</h1>
                        <p>Systemfel: Kunde inte ladda bilder</p>
                        <p style="margin-top: 20px; font-size: 16px;">
                            <i class="fas fa-exclamation-triangle"></i> 
                            Kontrollera att servern k√∂rs och att API:et √§r tillg√§ngligt
                        </p>
                        <button onclick="location.reload()" 
                                style="margin-top: 30px; padding: 10px 20px; background: white; color: #1e3c72; border: none; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-redo"></i> F√∂rs√∂k igen
                        </button>
                    </div>
                </div>
            `;
            
            // Uppdatera slide counter f√∂r felmeddelande
            document.getElementById('currentSlide').textContent = '1';
            document.getElementById('totalSlides').textContent = '1';
        }

        // Uppdatera slide counter
        function updateSlideCounter() {
            const currentEl = document.getElementById('currentSlide');
            const totalEl = document.getElementById('totalSlides');
            
            if (!currentEl || !totalEl) {
                console.warn('Slide counter elements not found');
                return;
            }
            
            currentEl.textContent = (currentSlide + 1).toString();
            totalEl.textContent = slides.length.toString();
        }

        // F√∂rhandsload n√§sta bild
        function preloadNextImage() {
            if (slides.length <= 1) return;
            
            const nextIndex = (currentSlide + 1) % slides.length;
            const nextSlide = slides[nextIndex];
            if (nextSlide && nextSlide.filename) {
                const img = new Image();
                img.src = `/images/${encodeURIComponent(nextSlide.filename)}`;
            }
        }

        // Initiera bildspelet
        function initSlideshow() {
            // Starta auto-rotation (10 sekunder per bild)
            if (slides.length > 1) {
                slideInterval = setInterval(nextSlide, 10000);
            }
            
            // L√§gg till event listeners f√∂r knappar
            document.getElementById('prevBtn').addEventListener('click', prevSlide);
            document.getElementById('nextBtn').addEventListener('click', nextSlide);
            document.getElementById('playPauseBtn').addEventListener('click', togglePlayPause);
            
            // L√§gg till tangentbordsnavigation
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') prevSlide();
                if (e.key === 'ArrowRight') nextSlide();
                if (e.key === ' ' || e.key === 'Spacebar') {
                    e.preventDefault();
                    togglePlayPause();
                }
            });
            
            // Touch events f√∂r mobila enheter
            let touchStartX = 0;
            let touchEndX = 0;
            
            document.querySelector('.main-content').addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });
            
            document.querySelector('.main-content').addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true });
            
            function handleSwipe() {
                const swipeThreshold = 50;
                const diff = touchStartX - touchEndX;
                
                if (Math.abs(diff) > swipeThreshold) {
                    if (diff > 0) {
                        nextSlide(); // Swipe v√§nster -> n√§sta
                    } else {
                        prevSlide(); // Swipe h√∂ger -> f√∂reg√•ende
                    }
                }
            }
        }

        // G√• till n√§sta bild
        function nextSlide() {
            if (slides.length <= 1) return;
            
            // D√∂lj nuvarande slide
            const currentSlideElement = document.querySelector('.slide.active');
            if (currentSlideElement) {
                currentSlideElement.classList.remove('active');
                currentSlideElement.setAttribute('aria-hidden', 'true');
            }
            
            // Uppdatera index
            currentSlide = (currentSlide + 1) % slides.length;
            
            // Visa n√§sta slide
            const nextSlideElement = document.querySelectorAll('.slide')[currentSlide];
            if (nextSlideElement) {
                nextSlideElement.classList.add('active');
                nextSlideElement.setAttribute('aria-hidden', 'false');
                
                // Scrolla info-texten till synlig position
                const slideInfo = nextSlideElement.querySelector('.slide-info');
                if (slideInfo) {
                    slideInfo.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }
            }
            
            // Uppdatera counter
            updateSlideCounter();
            
            // F√∂rhandsload n√§sta-n√§sta bild
            preloadNextImage();
        }

        // G√• till f√∂reg√•ende bild
        function prevSlide() {
            if (slides.length <= 1) return;
            
            // D√∂lj nuvarande slide
            const currentSlideElement = document.querySelector('.slide.active');
            if (currentSlideElement) {
                currentSlideElement.classList.remove('active');
                currentSlideElement.setAttribute('aria-hidden', 'true');
            }
            
            // Uppdatera index
            currentSlide = (currentSlide - 1 + slides.length) % slides.length;
            
            // Visa f√∂reg√•ende slide
            const prevSlideElement = document.querySelectorAll('.slide')[currentSlide];
            if (prevSlideElement) {
                prevSlideElement.classList.add('active');
                prevSlideElement.setAttribute('aria-hidden', 'false');
            }
            
            // Uppdatera counter
            updateSlideCounter();
        }

        // Pausa/starta bildspelet
        function togglePlayPause() {
            const button = document.getElementById('playPauseBtn');
            const icon = button.querySelector('i');
            
            if (isPlaying) {
                clearInterval(slideInterval);
                icon.className = 'fas fa-play';
                button.setAttribute('aria-label', 'Starta bildspel');
            } else {
                slideInterval = setInterval(nextSlide, 10000);
                icon.className = 'fas fa-pause';
                button.setAttribute('aria-label', 'Pausa bildspel');
            }
            
            isPlaying = !isPlaying;
        }

        // Ladda v√§derinformation
        async function loadWeather() {
            try {
                const response = await fetch('/api/weather');
                if (!response.ok) throw new Error('Weather API failed');
                
                const data = await response.json();
                
                let weatherHTML = '';
                if (data.current && data.current.temp !== undefined) {
                    const temp = Math.round(data.current.temp);
                    const description = data.current.weather[0]?.description || '';
                    const icon = getWeatherIcon(data.current.weather[0]?.main);
                    
                    weatherHTML = `
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div style="font-size: 48px;">${icon}</div>
                            <div>
                                <div style="font-size: 48px; font-weight: bold;">${temp}¬∞C</div>
                                <div style="font-size: 18px; text-transform: capitalize;">${description}</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; font-size: 14px; color: #666;">
                            <i class="fas fa-wind"></i> Vind: ${data.current.wind_speed || 0} m/s
                        </div>
                    `;
                } else {
                    weatherHTML = '<p>V√§derinformation ej tillg√§nglig</p>';
                }
                
                document.getElementById('weatherInfo').innerHTML = weatherHTML;
                
            } catch (error) {
                console.error('‚ùå Failed to load weather:', error);
                document.getElementById('weatherInfo').innerHTML = `
                    <p style="color: #666;">
                        <i class="fas fa-cloud-slash"></i> V√§derinformation ej tillg√§nglig
                    </p>
                `;
            }
        }

        // H√§mta v√§derikon
        function getWeatherIcon(condition) {
            const icons = {
                'Clear': '‚òÄÔ∏è',
                'Clouds': '‚òÅÔ∏è',
                'Rain': 'üåßÔ∏è',
                'Snow': '‚ùÑÔ∏è',
                'Thunderstorm': '‚õàÔ∏è',
                'Drizzle': 'üå¶Ô∏è',
                'Mist': 'üå´Ô∏è',
                'Fog': 'üåÅ'
            };
            return icons[condition] || '‚õÖ';
        }

        // Ladda kalenderh√§ndelser
        async function loadCalendar() {
            try {
                const response = await fetch('/api/calendar');
                if (!response.ok) throw new Error('Calendar API failed');
                
                const data = await response.json();
                
                let calendarHTML = '';
                if (data.events && data.events.length > 0) {
                    calendarHTML = '<ul style="list-style: none; padding: 0;">';
                    
                    data.events.slice(0, 5).forEach((event, index) => {
                        const startTime = new Date(event.start);
                        const endTime = new Date(event.end);
                        const timeFormat = { hour: '2-digit', minute: '2-digit' };
                        
                        const timeString = event.allDay 
                            ? 'Hela dagen' 
                            : `${startTime.toLocaleTimeString('sv-SE', timeFormat)} - ${endTime.toLocaleTimeString('sv-SE', timeFormat)}`;
                        
                        calendarHTML += `
                            <li style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: ${index < data.events.slice(0, 5).length - 1 ? '1px solid #f0f0f0' : 'none'}">
                                <div style="font-weight: bold; margin-bottom: 5px;">${event.title}</div>
                                <div style="font-size: 14px; color: #666;">
                                    <i class="far fa-clock"></i> ${timeString}
                                </div>
                                ${event.location ? `
                                <div style="font-size: 14px; color: #666; margin-top: 3px;">
                                    <i class="fas fa-map-marker-alt"></i> ${event.location}
                                </div>
                                ` : ''}
                            </li>
                        `;
                    });
                    
                    calendarHTML += '</ul>';
                    
                    if (data.events.length > 5) {
                        calendarHTML += `<div style="margin-top: 10px; font-size: 14px; color: #666;">
                            + ${data.events.length - 5} fler h√§ndelser
                        </div>`;
                    }
                } else {
                    calendarHTML = '<p style="color: #666;">Inga h√§ndelser idag</p>';
                }
                
                document.getElementById('calendarInfo').innerHTML = calendarHTML;
                
            } catch (error) {
                console.error('‚ùå Failed to load calendar:', error);
                document.getElementById('calendarInfo').innerHTML = `
                    <p style="color: #666;">
                        <i class="far fa-calendar-times"></i> Kalender ej tillg√§nglig
                    </p>
                `;
            }
        }

        // Uppdatera "senast uppdaterad"-tiden
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                now.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' });
        }

        // Debug-funktioner
        function debugImages() {
            console.log('=== DEBUG IMAGES ===');
            console.log('Slides array length:', slides.length);
            console.log('All slides:', slides);
            
            // Testa varje bild
            slides.forEach((slide, index) => {
                const url = `/images/${encodeURIComponent(slide.filename || slide.originalname || '')}`;
                console.log(`Slide ${index + 1}:`, {
                    id: slide.id,
                    filename: slide.filename,
                    originalname: slide.originalname,
                    url: url,
                    title: slide.title
                });
                
                // Testa om bilden finns
                checkImageExists(url).then(exists => {
                    console.log(`  Image exists: ${exists ? '‚úÖ' : '‚ùå'}`);
                });
            });
        }

        // Exponera viktiga funktioner globalt f√∂r debugging
        window.debugImages = debugImages;
        window.reloadSlides = loadSlides;
        window.getCurrentSlides = () => slides;
        window.testImage = (filename) => {
            const url = `/images/${encodeURIComponent(filename)}`;
            checkImageExists(url).then(exists => {
                console.log(`Image ${filename} exists:`, exists);
                if (!exists) {
                    console.log('Trying to open:', url);
                    window.open(url, '_blank');
                }
            });
        };
    </script>
</body>
</html>