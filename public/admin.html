<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Sj√§levads Bygg</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 32px; }
        .action-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .main-content {
            padding: 40px;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 40px;
        }
        .upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .upload-area {
            border: 3px dashed #1e3c72;
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
        }
        .upload-btn {
            background: #1e3c72;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            cursor: pointer;
        }
        #fileInput { display: none; }
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        .image-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .image-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .image-info { padding: 20px; }
        .image-actions { display: flex; gap: 10px; margin-top: 10px; }
        .image-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .sidebar { background: #f8f9fa; border-radius: 15px; padding: 30px; }
		.admin-thumbnail {
    width: 100%;
    height: 200px;
    object-fit: cover;
    transition: transform 0.3s ease;
    border-bottom: 3px solid #1e3c72;
}

.admin-thumbnail:hover {
    transform: scale(1.02);
}

.image-card:hover .admin-thumbnail {
    border-bottom-color: #4ecdc4;
}

.image-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.edit-btn {
    background: #f0f7ff;
    color: #1e3c72;
    border: 1px solid #1e3c72;
}

.edit-btn:hover {
    background: #e0eeff;
}

.delete-btn {
    background: #fff0f0;
    color: #e74c3c;
    border: 1px solid #e74c3c;
}

.delete-btn:hover {
    background: #ffe0e0;
}

/* Progress bar f√∂r uploads */
.upload-progress {
    width: 100%;
    height: 4px;
    background: #eee;
    border-radius: 2px;
    margin-top: 10px;
    overflow: hidden;
}

.upload-progress-bar {
    height: 100%;
    background: #1e3c72;
    width: 0%;
    transition: width 0.3s ease;
}
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-cogs"></i> Admin Panel - Bildhantering</h1>
            <div>
                <button class="action-btn" id="refreshBtn"><i class="fas fa-sync-alt"></i> Uppdatera</button>
                <button class="action-btn" id="backBtn"><i class="fas fa-arrow-left"></i> Tillbaka</button>
            </div>
        </header>

        <main class="main-content">
            <div class="left-column">
                <section class="upload-section">
                    <h2><i class="fas fa-cloud-upload-alt"></i> Ladda upp bilder</h2>
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 64px; color: #1e3c72; margin-bottom: 20px;"></i>
                        <h3>Drag & drop bilder h√§r</h3>
                        <p>eller klicka f√∂r att bl√§ddra</p>
                        <button class="upload-btn">V√§lj filer</button>
                        <input type="file" id="fileInput" multiple accept="image/*">
                    </div>
                </section>

                <section>
                    <h2>Alla bilder (<span id="totalImages">0</span>)</h2>
                    <div class="images-grid" id="imagesGrid">
                        <!-- Images load here -->
                    </div>
                </section>
            </div>

            <aside class="sidebar">
                <section style="margin-bottom: 40px;">
                    <h3>Statistik</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;">
                        <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #1e3c72;" id="imagesCount">0</div>
                            <div>Bilder</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #1e3c72;" id="activeSlides">0</div>
                            <div>Aktiva</div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3>Inst√§llningar</h3>
                    <div style="margin-top: 20px;">
                        <label style="display: block; margin-bottom: 10px;">
                            <input type="checkbox" id="autoSlide" checked> Automatisk bildv√§xling
                        </label>
                        <label style="display: block; margin-bottom: 10px;">
                            <input type="number" id="slideInterval" value="10" min="5" max="60" style="width: 60px;"> sekunder
                        </label>
                    </div>
                </section>
            </aside>
        </main>
    </div>

    <script>
        let images = [];

        document.addEventListener('DOMContentLoaded', async () => {
            await loadImages();
            setupEventListeners();
        });

		async function loadImages() {
			try {
				console.log('üîÑ Loading images from API...');
				const response = await fetch('/api/images');
				
				if (!response.ok) {
					throw new Error(`API error: ${response.status}`);
				}
				
				images = await response.json();
				console.log(`‚úÖ Loaded ${images.length} image(s)`);
				
				renderImages();
				updateStats();
				
			} catch (error) {
				console.error('‚ùå Failed to load images:', error);
				showError('Kunde inte ladda bilder. Kontrollera att servern k√∂rs.');
				renderFallback();
			}
		}

		function renderImages() {
			const grid = document.getElementById('imagesGrid');
			const total = document.getElementById('totalImages');
			
			grid.innerHTML = '';
			
			if (images.length === 0) {
				grid.innerHTML = `
					<div style="grid-column: 1 / -1; text-align: center; padding: 60px;">
						<i class="fas fa-image" style="font-size: 64px; color: #ccc; margin-bottom: 20px;"></i>
						<h3 style="color: #666;">Inga bilder tillg√§ngliga</h3>
						<p style="color: #888;">Ladda upp bilder med formul√§ret ovan</p>
					</div>
				`;
				total.textContent = '0';
				return;
			}
			
			images.forEach((image, index) => {
				const card = document.createElement('div');
				card.className = 'image-card';
				card.dataset.id = image.id;
				card.dataset.filename = image.filename;
				
				// Skapa bild-URL - anv√§nd originalfilnamn
				const imageUrl = `/images/${image.filename}`;
				const thumbnailUrl = `/thumbnails/${image.filename}`;
				
				card.innerHTML = `
					<img src="${thumbnailUrl}" 
						 alt="${image.title || image.filename}"
						 class="admin-thumbnail"
						 data-full="${imageUrl}"
						 onerror="handleAdminImageError(this, '${image.filename}')">
					<div class="image-info">
						<h3 title="${image.title || image.filename}">
							${image.title || image.filename.substring(0, 20)}
							${image.filename.length > 20 ? '...' : ''}
						</h3>
						<p style="font-size: 12px; color: #666; margin: 5px 0;">
							${formatFileSize(image.size)} ‚Ä¢ ${new Date(image.uploaded).toLocaleDateString('sv-SE')}
						</p>
						<div class="image-actions">
							<button class="image-btn edit-btn" data-action="edit" title="Redigera">
								<i class="fas fa-edit"></i> Redigera
							</button>
							<button class="image-btn delete-btn" data-action="delete" title="Ta bort">
								<i class="fas fa-trash"></i> Ta bort
							</button>
						</div>
					</div>
				`;
				
				grid.appendChild(card);
			});
			
			total.textContent = images.length;
		}

		function handleAdminImageError(imgElement, filename) {
			console.warn(`‚ö†Ô∏è Thumbnail failed: ${filename}`);
			
			// F√∂rs√∂k med full-size bilden ist√§llet
			const fullUrl = imgElement.dataset.full;
			if (fullUrl && fullUrl !== imgElement.src) {
				imgElement.src = fullUrl;
				imgElement.onerror = null; // F√∂rhindra loop
				return;
			}
			
			// Fallback
			imgElement.src = 'https://via.placeholder.com/400x300/1e3c72/ffffff?text=Thumbnail';
			imgElement.style.opacity = '0.7';
		}

		function formatFileSize(bytes) {
			if (bytes === 0) return '0 Bytes';
			const k = 1024;
			const sizes = ['Bytes', 'KB', 'MB', 'GB'];
			const i = Math.floor(Math.log(bytes) / Math.log(k));
			return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
		}

		function showError(message) {
			// Visa felmeddelande
			const errorDiv = document.createElement('div');
			errorDiv.style.cssText = `
				position: fixed;
				top: 20px;
				right: 20px;
				background: #e74c3c;
				color: white;
				padding: 15px 25px;
				border-radius: 8px;
				z-index: 1000;
				box-shadow: 0 4px 12px rgba(0,0,0,0.2);
			`;
			errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
			document.body.appendChild(errorDiv);
			
			setTimeout(() => errorDiv.remove(), 5000);
		}

		function renderFallback() {
			const grid = document.getElementById('imagesGrid');
			grid.innerHTML = `
				<div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
					<div style="color: #e74c3c; font-size: 48px; margin-bottom: 20px;">
						<i class="fas fa-exclamation-circle"></i>
					</div>
					<h3>Kan inte ansluta till servern</h3>
					<p>Kontrollera att info-sk√§rm servern k√∂rs:</p>
					<pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: left; margin: 20px auto; max-width: 500px;">
		sudo systemctl status infoscreen
					</pre>
					<button onclick="location.reload()" style="padding: 10px 20px; background: #1e3c72; color: white; border: none; border-radius: 5px;">
						<i class="fas fa-sync-alt"></i> F√∂rs√∂k igen
					</button>
				</div>
			`;
		}

        function updateStats() {
            document.getElementById('imagesCount').textContent = images.length;
            const active = images.filter(img => img.active !== false).length;
            document.getElementById('activeSlides').textContent = active;
        }

        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
		fileInput.addEventListener('change', async (e) => {
			if (e.target.files.length === 0) return;
			
			const uploadArea = document.getElementById('uploadArea');
			const originalHTML = uploadArea.innerHTML;
			
			// Visa laddningsstatus
			uploadArea.innerHTML = `
				<div style="text-align: center;">
					<i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #1e3c72;"></i>
					<p>Laddar upp ${e.target.files.length} bild(er)...</p>
				</div>
			`;
			
			const formData = new FormData();
			for (const file of e.target.files) {
				formData.append('image', file);
			}
			
			try {
				const response = await fetch('/api/upload', {
					method: 'POST',
					body: formData
				});
				
				if (!response.ok) {
					const error = await response.json();
					throw new Error(error.error || 'Uppladdning misslyckades');
				}
				
				const result = await response.json();
				
				if (result.success) {
					// Visa success meddelande
					uploadArea.innerHTML = `
						<div style="text-align: center; color: #27ae60;">
							<i class="fas fa-check-circle" style="font-size: 48px;"></i>
							<p>${e.target.files.length} bild(er) uppladdade!</p>
						</div>
					`;
					
					// Ladda om bildlistan efter 2 sekunder
					setTimeout(() => {
						loadImages();
						uploadArea.innerHTML = originalHTML;
					}, 2000);
					
				} else {
					throw new Error(result.error || 'Ok√§nt fel');
				}
				
			} catch (error) {
				console.error('Upload error:', error);
				
				uploadArea.innerHTML = `
					<div style="text-align: center; color: #e74c3c;">
						<i class="fas fa-times-circle" style="font-size: 48px;"></i>
						<p>Fel vid uppladdning: ${error.message}</p>
						<button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background: #1e3c72; color: white; border: none; border-radius: 5px;">
							F√∂rs√∂k igen
						</button>
					</div>
				`;
				
				// √Öterst√§ll efter 5 sekunder
				setTimeout(() => {
					uploadArea.innerHTML = originalHTML;
				}, 5000);
			}
			
			// √Öterst√§ll file input
			fileInput.value = '';
		});
            
            document.getElementById('refreshBtn').addEventListener('click', loadImages);
            document.getElementById('backBtn').addEventListener('click', () => {
                window.location.href = '/';
            });
            
            // Event delegation for image actions
            document.getElementById('imagesGrid').addEventListener('click', async (e) => {
                const card = e.target.closest('.image-card');
                if (!card) return;
                
                const actionBtn = e.target.closest('.image-btn');
                if (!actionBtn) return;
                
                const imageId = card.dataset.id;
                const action = actionBtn.dataset.action;
                
                const image = images.find(img => img.id == imageId);
                if (!image) return;
                
                if (action === 'delete') {
                    if (confirm('Ta bort denna bild?')) {
                        try {
                            await fetch(`/api/images/${imageId}`, { method: 'DELETE' });
                            await loadImages();
                        } catch (error) {
                            alert('Kunde inte ta bort bilden');
                        }
                    }
                } else if (action === 'edit') {
                    // Simple edit - just prompt for new title
                    const newTitle = prompt('Ny titel:', image.title || '');
                    if (newTitle !== null) {
                        try {
                            await fetch(`/api/images/${imageId}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ title: newTitle })
                            });
                            await loadImages();
                        } catch (error) {
                            alert('Kunde inte uppdatera bilden');
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>